<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${country.countryName} + ' - ì„¸ê³„ ì¸êµ¬ ëŒ€ì‹œë³´ë“œ'">
      êµ­ê°€ ìƒì„¸
    </title>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 28px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .back-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid white;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        transition: background 0.3s;
        display: inline-block;
      }

      .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 20px;
      }

      .country-header {
        background: white;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        text-align: center;
      }

      .country-flag {
        margin-bottom: 20px;
      }

      .country-flag img {
        width: 120px;
        height: 80px;
        object-fit: cover;
        border-radius: 5px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        border: 2px solid #e0e0e0;
      }

      .country-name {
        font-size: 48px;
        color: #333;
        margin-bottom: 10px;
      }

      .country-code {
        font-size: 24px;
        color: #999;
        font-weight: 300;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      }

      .stat-card h3 {
        color: #666;
        font-size: 14px;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .stat-card .value {
        font-size: 36px;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
      }

      .stat-card .label {
        font-size: 14px;
        color: #999;
      }

      .stat-card.population .value {
        color: #667eea;
      }

      .stat-card.area .value {
        color: #48bb78;
      }

      .stat-card.density .value {
        color: #ed8936;
      }

      .stat-card.gdp .value {
        color: #9f7aea;
      }

      .stat-card.life .value {
        color: #f56565;
      }

      .stat-card.continent .value {
        color: #38b2ac;
      }

      .section {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .section h2 {
        margin-bottom: 20px;
        color: #333;
        font-size: 24px;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #667eea;
      }

      .info-item .label {
        font-weight: 600;
        color: #555;
      }

      .info-item .value {
        color: #333;
        text-align: right;
      }

      .progress-bar {
        width: 100%;
        height: 30px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
        margin-top: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
        transition: width 1s ease;
      }

      .comparison-section {
        margin-top: 20px;
      }

      .rank-badge {
        display: inline-block;
        padding: 5px 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        font-weight: bold;
        font-size: 14px;
      }

      .metric-comparison {
        margin-bottom: 25px;
      }

      .metric-comparison h4 {
        color: #555;
        margin-bottom: 10px;
        font-size: 16px;
      }

      @media (max-width: 768px) {
        .country-name {
          font-size: 32px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .info-grid {
          grid-template-columns: 1fr;
        }
      }

      /* ë‰´ìŠ¤ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
      .loading-spinner {
        width: 40px;
        height: 40px;
        margin: 0 auto 15px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .news-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
      }

      .news-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border-left: 4px solid #667eea;
        transition: transform 0.3s, box-shadow 0.3s;
        cursor: pointer;
      }

      .news-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .news-card h3 {
        color: #333;
        font-size: 18px;
        margin-bottom: 10px;
        line-height: 1.4;
      }

      .news-card h3 a {
        color: #333;
        text-decoration: none;
        transition: color 0.3s;
      }

      .news-card h3 a:hover {
        color: #667eea;
      }

      .news-description {
        color: #666;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 15px;
      }

      .news-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #999;
      }

      .news-source {
        font-weight: 600;
        color: #667eea;
      }

      .news-date {
        color: #999;
      }

      .news-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        border-radius: 5px;
        margin-bottom: 15px;
      }

      .no-news {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .no-news-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      /* ì°¨íŠ¸ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
      .chart-container {
        position: relative;
        height: 400px;
        margin-top: 20px;
      }

      .chart-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
      }

      .chart-tab {
        padding: 10px 20px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #666;
        transition: all 0.3s;
      }

      .chart-tab:hover {
        color: #667eea;
      }

      .chart-tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }

      .chart-info {
        background: #f0f4ff;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        border-left: 4px solid #667eea;
      }

      .chart-info p {
        margin: 0;
        color: #555;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <h1>ğŸŒ ì„¸ê³„ ì¸êµ¬ ëŒ€ì‹œë³´ë“œ</h1>
        <a href="/dashboard" class="back-btn">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
      </div>
    </div>

    <div class="container">
      <!-- êµ­ê°€ í—¤ë” -->
      <div class="country-header">
        <div class="country-flag">
          <!-- Flagpedia API ì‚¬ìš© (ë¬´ë£Œ, CDN) -->
          <img
            th:src="'https://flagcdn.com/w320/' + ${#strings.toLowerCase(country.countryCode)} + '.png'"
            th:alt="${country.countryName} + ' êµ­ê¸°'"
            th:onerror="'this.onerror=null; this.src=\'https://flagcdn.com/w320/un.png\';'"
          />
        </div>
        <h1 class="country-name" th:text="${country.countryName}">ëŒ€í•œë¯¼êµ­</h1>
        <p class="country-country-code" th:text="${country.countryCode}">KOR</p>
      </div>

      <!-- ì£¼ìš” í†µê³„ ì¹´ë“œ -->
      <div class="stats-grid">
        <div class="stat-card population">
          <h3>ì´ ì¸êµ¬</h3>
          <div
            class="value"
            th:text="${#numbers.formatInteger(country.population, 0, 'COMMA')}"
          >
            51,784,059
          </div>
          <div class="label">ëª…</div>
        </div>

        <div class="stat-card area">
          <h3>ë©´ì </h3>
          <div
            class="value"
            th:text="${#numbers.formatDecimal(country.areaSqKm, 0, 'COMMA', 2, 'POINT')}"
          >
            100,210
          </div>
          <div class="label">kmÂ²</div>
        </div>

        <div class="stat-card density">
          <h3>ì¸êµ¬ ë°€ë„</h3>
          <div
            class="value"
            th:text="${#numbers.formatDecimal(country.populationDensity, 0, 'COMMA', 2, 'POINT')}"
          >
            516.78
          </div>
          <div class="label">ëª…/kmÂ²</div>
        </div>

        <div class="stat-card gdp">
          <h3>1ì¸ë‹¹ GDP</h3>
          <div
            class="value"
            th:text="${'$' + #numbers.formatDecimal(country.gdpPerCapita, 0, 'COMMA', 2, 'POINT')}"
          >
            $34,165
          </div>
          <div class="label">USD</div>
        </div>

        <div class="stat-card life">
          <h3>ê¸°ëŒ€ ìˆ˜ëª…</h3>
          <div
            class="value"
            th:text="${#numbers.formatDecimal(country.lifeExpectancy, 0, 2)}"
          >
            83.73
          </div>
          <div class="label">ì„¸</div>
        </div>

        <div class="stat-card continent">
          <h3>ëŒ€ë¥™</h3>
          <div
            class="value"
            th:text="${country.continent}"
            style="font-size: 28px"
          >
            Asia
          </div>
          <div class="label">
            <a
              th:href="@{/continent/{continent}(continent=${country.continent})}"
              style="color: #38b2ac; text-decoration: none"
            >
              ëŒ€ë¥™ ë³´ê¸° â†’
            </a>
          </div>
        </div>
      </div>

      <!-- ë¹„êµ ë¶„ì„ -->
      <div class="section">
        <h2>ğŸ“ˆ ì„¸ê³„ í‰ê·  ëŒ€ë¹„ ë¹„êµ</h2>

        <div class="metric-comparison">
          <h4>
            1ì¸ë‹¹ GDP
            <span class="rank-badge" th:if="${country.gdpPerCapita > 30000}"
              >ìƒìœ„ê¶Œ</span
            >
            <span
              class="rank-badge"
              th:if="${country.gdpPerCapita <= 30000 && country.gdpPerCapita > 10000}"
              style="background: #ed8936"
              >ì¤‘ìœ„ê¶Œ</span
            >
            <span
              class="rank-badge"
              th:if="${country.gdpPerCapita <= 10000}"
              style="background: #718096"
              >í•˜ìœ„ê¶Œ</span
            >
          </h4>
          <div class="progress-bar">
            <div
              class="progress-fill"
              th:style="'width: ' + ${country.gdpPerCapita > 80000 ? 100 : (country.gdpPerCapita / 800)} + '%'"
              th:text="${'$' + #numbers.formatDecimal(country.gdpPerCapita, 0, 'COMMA', 2, 'POINT')}"
            >
              $34,165
            </div>
          </div>
        </div>

        <div class="metric-comparison">
          <h4>
            ê¸°ëŒ€ ìˆ˜ëª…
            <span class="rank-badge" th:if="${country.lifeExpectancy > 80}"
              >ë†’ìŒ</span
            >
            <span
              class="rank-badge"
              th:if="${country.lifeExpectancy <= 80 && country.lifeExpectancy > 70}"
              style="background: #ed8936"
              >ë³´í†µ</span
            >
            <span
              class="rank-badge"
              th:if="${country.lifeExpectancy <= 70}"
              style="background: #718096"
              >ë‚®ìŒ</span
            >
          </h4>
          <div class="progress-bar">
            <div
              class="progress-fill"
              th:style="'width: ' + ${(country.lifeExpectancy / 90) * 100} + '%'"
              th:text="${#numbers.formatDecimal(country.lifeExpectancy, 0, 2)} + 'ì„¸'"
            >
              83.73ì„¸
            </div>
          </div>
        </div>

        <div class="metric-comparison">
          <h4>
            ì¸êµ¬ ë°€ë„
            <span class="rank-badge" th:if="${country.populationDensity > 400}"
              >ë§¤ìš° ë†’ìŒ</span
            >
            <span
              class="rank-badge"
              th:if="${country.populationDensity <= 400 && country.populationDensity > 100}"
              style="background: #ed8936"
              >ë³´í†µ</span
            >
            <span
              class="rank-badge"
              th:if="${country.populationDensity <= 100}"
              style="background: #48bb78"
              >ë‚®ìŒ</span
            >
          </h4>
          <div class="progress-bar">
            <div
              class="progress-fill"
              th:style="'width: ' + ${country.populationDensity > 1000 ? 100 : (country.populationDensity / 10)} + '%'"
              th:text="${#numbers.formatDecimal(country.populationDensity, 0, 2)} + ' ëª…/kmÂ²'"
            >
              516.78 ëª…/kmÂ²
            </div>
          </div>
        </div>
      </div>

      <!-- ì¸êµ¬ ë³€í™” ê·¸ë˜í”„ -->
      <div class="section">
        <h2>ğŸ“Š ì¸êµ¬ ë³€í™” ì¶”ì´</h2>

        <div class="chart-info">
          <p>ğŸ“… ìµœê·¼ ì—°ë„ë³„ ì¸êµ¬ ë³€í™”ì™€ ì„±ì¥ë¥ ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="chart-tabs">
          <button class="chart-tab active" onclick="switchChart('population')">
            ì¸êµ¬ ì¶”ì´
          </button>
          <button class="chart-tab" onclick="switchChart('growth')">
            ì„±ì¥ë¥ 
          </button>
          <button class="chart-tab" onclick="switchChart('combined')">
            ë³µí•© ì°¨íŠ¸
          </button>
        </div>

        <div class="chart-container">
          <canvas id="populationChart"></canvas>
        </div>
      </div>

      <!-- ìƒì„¸ ì •ë³´ -->
      <div class="section">
        <h2>ğŸ“Š ìƒì„¸ ì •ë³´</h2>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">êµ­ê°€ ì½”ë“œ</span>
            <span class="value" th:text="${country.countryCode}">KOR</span>
          </div>

          <div class="info-item">
            <span class="label">ë°ì´í„° ê¸°ì¤€ë…„ë„</span>
            <span class="value" th:text="${country.year}">2023</span>
          </div>

          <div class="info-item">
            <span class="label">ì¸êµ¬</span>
            <span
              class="value"
              th:text="${#numbers.formatInteger(country.population, 0, 'COMMA')} + 'ëª…'"
              >51,784,059ëª…</span
            >
          </div>

          <div class="info-item">
            <span class="label">ì´ ë©´ì </span>
            <span
              class="value"
              th:text="${#numbers.formatDecimal(country.areaSqKm, 0, 'COMMA', 2, 'POINT')} + ' kmÂ²'"
              >100,210 kmÂ²</span
            >
          </div>

          <div class="info-item">
            <span class="label">ì¸êµ¬ ë°€ë„</span>
            <span
              class="value"
              th:text="${#numbers.formatDecimal(country.populationDensity, 0, 'COMMA', 2, 'POINT')} + ' ëª…/kmÂ²'"
              >516.78 ëª…/kmÂ²</span
            >
          </div>

          <div class="info-item">
            <span class="label">1ì¸ë‹¹ GDP</span>
            <span
              class="value"
              th:text="${'$' + #numbers.formatDecimal(country.gdpPerCapita, 0, 'COMMA', 2, 'POINT')}"
              >$34,165</span
            >
          </div>

          <div class="info-item">
            <span class="label">í‰ê·  ê¸°ëŒ€ìˆ˜ëª…</span>
            <span
              class="value"
              th:text="${#numbers.formatDecimal(country.lifeExpectancy, 0, 2)} + 'ì„¸'"
              >83.73ì„¸</span
            >
          </div>

          <div class="info-item">
            <span class="label">ì†Œì† ëŒ€ë¥™</span>
            <span class="value" th:text="${country.continent}">Asia</span>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>â„¹ï¸ ì¶”ê°€ ì •ë³´</h2>
        <p style="color: #666; line-height: 1.8">
          <strong th:text="${country.countryName}">ëŒ€í•œë¯¼êµ­</strong>ì€(ëŠ”)
          <strong th:text="${country.continent}">Asia</strong> ëŒ€ë¥™ì— ìœ„ì¹˜í•œ
          êµ­ê°€ë¡œ, ì•½
          <strong
            th:text="${#numbers.formatInteger(country.population, 0, 'COMMA')} + 'ëª…'"
            >51,784,059ëª…</strong
          >ì˜ ì¸êµ¬ê°€ ê±°ì£¼í•˜ê³  ìˆìŠµë‹ˆë‹¤. <br /><br />
          ì´ ë©´ì ì€
          <strong
            th:text="${#numbers.formatDecimal(country.areaSqKm, 0, 'COMMA', 2, 'POINT')} + ' kmÂ²'"
            >100,210 kmÂ²</strong
          >ì´ë©°, ì¸êµ¬ ë°€ë„ëŠ”
          <strong
            th:text="${#numbers.formatDecimal(country.populationDensity, 0, 2)} + ' ëª…/kmÂ²'"
            >516.78 ëª…/kmÂ²</strong
          >ì…ë‹ˆë‹¤. <br /><br />
          1ì¸ë‹¹ GDPëŠ”
          <strong
            th:text="${'$' + #numbers.formatDecimal(country.gdpPerCapita, 0, 'COMMA', 2, 'POINT')}"
            >$34,165</strong
          >ì´ë©°, í‰ê·  ê¸°ëŒ€ìˆ˜ëª…ì€
          <strong
            th:text="${#numbers.formatDecimal(country.lifeExpectancy, 0, 2)} + 'ì„¸'"
            >83.73ì„¸</strong
          >ì…ë‹ˆë‹¤.
        </p>
      </div>

      <!-- ê´€ë ¨ ë‰´ìŠ¤ -->
      <div class="section">
        <h2>ğŸ“° ê´€ë ¨ ë‰´ìŠ¤</h2>
        <div id="newsContainer">
          <div style="text-align: center; padding: 40px; color: #999">
            <div class="loading-spinner"></div>
            <p>ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        </div>
      </div>

      <!-- ê´€ë ¨ ë§í¬ -->
      <div class="section">
        <h2>ğŸ”— ê´€ë ¨ ì •ë³´</h2>
        <div style="display: flex; gap: 10px; flex-wrap: wrap">
          <a
            th:href="@{/continent/{continent}(continent=${country.continent})}"
            style="
              padding: 10px 20px;
              background: #667eea;
              color: white;
              text-decoration: none;
              border-radius: 5px;
              display: inline-block;
            "
          >
            ê°™ì€ ëŒ€ë¥™ êµ­ê°€ ë³´ê¸°
          </a>
          <a
            href="/dashboard"
            style="
              padding: 10px 20px;
              background: #48bb78;
              color: white;
              text-decoration: none;
              border-radius: 5px;
              display: inline-block;
            "
          >
            ì „ì²´ êµ­ê°€ ëª©ë¡
          </a>
        </div>
      </div>
    </div>

    <script>
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì• ë‹ˆë©”ì´ì…˜
      document.addEventListener("DOMContentLoaded", function () {
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì• ë‹ˆë©”ì´ì…˜
        const progressBars = document.querySelectorAll(".progress-fill");
        progressBars.forEach((bar) => {
          const width = bar.style.width;
          bar.style.width = "0%";
          setTimeout(() => {
            bar.style.width = width;
          }, 100);
        });

        // ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜
        const cards = document.querySelectorAll(".stat-card");
        cards.forEach((card, index) => {
          card.style.opacity = "0";
          card.style.transform = "translateY(20px)";
          setTimeout(() => {
            card.style.transition = "opacity 0.5s, transform 0.5s";
            card.style.opacity = "1";
            card.style.transform = "translateY(0)";
          }, index * 100);
        });

        // ë‰´ìŠ¤ ë¡œë“œ
        loadNews();

        // ì¸êµ¬ ë³€í™” ê·¸ë˜í”„ ë¡œë“œ
        loadPopulationChart();
      });

      // ë‰´ìŠ¤ API í˜¸ì¶œ
      async function loadNews() {
        const countryName = document.querySelector(".country-name").textContent;
        const newsContainer = document.getElementById("newsContainer");

        try {
          // ì„œë²„ API í˜¸ì¶œ
          const response = await fetch(
            `/api/news/country/${encodeURIComponent(countryName)}`
          );

          if (!response.ok) {
            throw new Error("ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          }

          const articles = await response.json();
          displayNews(articles);
        } catch (error) {
          console.error("ë‰´ìŠ¤ ë¡œë”© ì˜¤ë¥˜:", error);
          newsContainer.innerHTML = `
                    <div class="no-news">
                        <div class="no-news-icon">ğŸ“°</div>
                        <p>ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                        <p style="font-size: 14px; margin-top: 10px;">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
        }
      }

      // ë‰´ìŠ¤ í‘œì‹œ
      function displayNews(articles) {
        const newsContainer = document.getElementById("newsContainer");

        if (!articles || articles.length === 0) {
          newsContainer.innerHTML = `
                    <div class="no-news">
                        <div class="no-news-icon">ğŸ“°</div>
                        <p>ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
          return;
        }

        const newsHTML = articles
          .slice(0, 6)
          .map(
            (article) => `
                <div class="news-card">
                    ${
                      article.image
                        ? `<img src="${article.image}" alt="${article.title}" class="news-image" onerror="this.style.display='none'">`
                        : ""
                    }
                    <h3>
                        <a href="${
                          article.url
                        }" target="_blank" rel="noopener noreferrer">
                            ${article.title}
                        </a>
                    </h3>
                    <p class="news-description">${
                      article.description || "ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤."
                    }</p>
                    <div class="news-meta">
                        <span class="news-source">${article.source}</span>
                        <span class="news-date">${article.date}</span>
                    </div>
                </div>
            `
          )
          .join("");

        newsContainer.innerHTML = `<div class="news-grid">${newsHTML}</div>`;
      }

      // Chart.js ì¸ìŠ¤í„´ìŠ¤ ì €ì¥
      let populationChartInstance = null;

      // ì¸êµ¬ ë³€í™” ë°ì´í„° ë¡œë“œ ë° ì°¨íŠ¸ ìƒì„±
      async function loadPopulationChart() {
        // const countryCode = document.querySelector(".country-code").textContent;
        const countryCode = document.querySelector(
          ".country-country-code"
        ).textContent;

        try {
          // ì„œë²„ì—ì„œ ì¸êµ¬ ë³€í™” ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          const response = await fetch(
            `/api/population/history/${countryCode}`
          );

          if (!response.ok) {
            throw new Error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          }

          const historyData = await response.json();

          // ì°¨íŠ¸ ìƒì„±
          createPopulationChart(historyData);
        } catch (error) {
          console.error("ì¸êµ¬ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", error);
          // ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©
          createPopulationChart(getSampleHistoryData());
        }
      }

      // ìƒ˜í”Œ ì¸êµ¬ ë³€í™” ë°ì´í„°
      function getSampleHistoryData() {
        return [
          { year: 2018, population: 51630000, growthRate: 0.15 },
          { year: 2019, population: 51710000, growthRate: 0.16 },
          { year: 2020, population: 51780579, growthRate: 0.09 },
          { year: 2021, population: 51815810, growthRate: 0.07 },
          { year: 2022, population: 51628117, growthRate: -0.36 },
          { year: 2023, population: 51784059, growthRate: 0.3 },
        ];
      }

      // ì°¨íŠ¸ ìƒì„±
      function createPopulationChart(data) {
        const ctx = document.getElementById("populationChart").getContext("2d");

        // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        if (populationChartInstance) {
          populationChartInstance.destroy();
        }

        // ë°ì´í„° ì¤€ë¹„
        const years = data.map((d) => d.year);
        const populations = data.map((d) => d.population);
        const growthRates = data.map((d) => d.growthRate);

        // ì°¨íŠ¸ ìƒì„±
        populationChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: years,
            datasets: [
              {
                label: "ì¸êµ¬ (ëª…)",
                data: populations,
                borderColor: "#667eea",
                backgroundColor: "rgba(102, 126, 234, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: "#667eea",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "top",
                labels: {
                  font: {
                    size: 14,
                    weight: "bold",
                  },
                  padding: 20,
                },
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                padding: 12,
                titleFont: {
                  size: 14,
                  weight: "bold",
                },
                bodyFont: {
                  size: 13,
                },
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label || "";
                    if (label) {
                      label += ": ";
                    }
                    label += context.parsed.y.toLocaleString();
                    return label;
                  },
                },
              },
            },
            scales: {
              y: {
                beginAtZero: false,
                ticks: {
                  callback: function (value) {
                    return value.toLocaleString();
                  },
                  font: {
                    size: 12,
                  },
                },
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
              },
              x: {
                ticks: {
                  font: {
                    size: 12,
                    weight: "bold",
                  },
                },
                grid: {
                  display: false,
                },
              },
            },
          },
        });

        // ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„° ì €ì¥ (ì°¨íŠ¸ ì „í™˜ìš©)
        window.chartData = { years, populations, growthRates };
      }

      // ì°¨íŠ¸ íƒ€ì… ì „í™˜
      function switchChart(type) {
        // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
        document.querySelectorAll(".chart-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        if (!window.chartData) return;

        const { years, populations, growthRates } = window.chartData;
        const ctx = document.getElementById("populationChart").getContext("2d");

        // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        if (populationChartInstance) {
          populationChartInstance.destroy();
        }

        // ì°¨íŠ¸ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ ì„¤ì •
        let chartConfig = {};

        if (type === "population") {
          // ì¸êµ¬ ì¶”ì´ ì°¨íŠ¸
          chartConfig = {
            type: "line",
            data: {
              labels: years,
              datasets: [
                {
                  label: "ì¸êµ¬ (ëª…)",
                  data: populations,
                  borderColor: "#667eea",
                  backgroundColor: "rgba(102, 126, 234, 0.1)",
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  pointRadius: 5,
                  pointHoverRadius: 7,
                },
              ],
            },
            options: getChartOptions("ì¸êµ¬"),
          };
        } else if (type === "growth") {
          // ì„±ì¥ë¥  ì°¨íŠ¸
          chartConfig = {
            type: "bar",
            data: {
              labels: years,
              datasets: [
                {
                  label: "ì„±ì¥ë¥  (%)",
                  data: growthRates,
                  backgroundColor: growthRates.map((rate) =>
                    rate >= 0
                      ? "rgba(72, 187, 120, 0.7)"
                      : "rgba(245, 101, 101, 0.7)"
                  ),
                  borderColor: growthRates.map((rate) =>
                    rate >= 0 ? "#48bb78" : "#f56565"
                  ),
                  borderWidth: 2,
                },
              ],
            },
            options: getChartOptions("ì„±ì¥ë¥ "),
          };
        } else if (type === "combined") {
          // ë³µí•© ì°¨íŠ¸ (ì¸êµ¬ + ì„±ì¥ë¥ )
          chartConfig = {
            type: "line",
            data: {
              labels: years,
              datasets: [
                {
                  label: "ì¸êµ¬ (ëª…)",
                  data: populations,
                  borderColor: "#667eea",
                  backgroundColor: "rgba(102, 126, 234, 0.1)",
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  yAxisID: "y",
                },
                {
                  label: "ì„±ì¥ë¥  (%)",
                  data: growthRates,
                  borderColor: "#48bb78",
                  backgroundColor: "rgba(72, 187, 120, 0.1)",
                  borderWidth: 2,
                  fill: false,
                  tension: 0.4,
                  yAxisID: "y1",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: "index",
                intersect: false,
              },
              plugins: {
                legend: {
                  display: true,
                  position: "top",
                },
                tooltip: {
                  backgroundColor: "rgba(0, 0, 0, 0.8)",
                  padding: 12,
                },
              },
              scales: {
                y: {
                  type: "linear",
                  display: true,
                  position: "left",
                  ticks: {
                    callback: function (value) {
                      return value.toLocaleString();
                    },
                  },
                },
                y1: {
                  type: "linear",
                  display: true,
                  position: "right",
                  grid: {
                    drawOnChartArea: false,
                  },
                  ticks: {
                    callback: function (value) {
                      return value + "%";
                    },
                  },
                },
                x: {
                  grid: {
                    display: false,
                  },
                },
              },
            },
          };
        }

        populationChartInstance = new Chart(ctx, chartConfig);
      }

      // ì°¨íŠ¸ ì˜µì…˜ ìƒì„± í•¨ìˆ˜
      function getChartOptions(type) {
        return {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: "top",
              labels: {
                font: {
                  size: 14,
                  weight: "bold",
                },
                padding: 20,
              },
            },
            tooltip: {
              backgroundColor: "rgba(0, 0, 0, 0.8)",
              padding: 12,
              titleFont: {
                size: 14,
                weight: "bold",
              },
              bodyFont: {
                size: 13,
              },
              callbacks: {
                label: function (context) {
                  let label = context.dataset.label || "";
                  if (label) {
                    label += ": ";
                  }
                  if (type === "ì„±ì¥ë¥ ") {
                    label += context.parsed.y + "%";
                  } else {
                    label += context.parsed.y.toLocaleString();
                  }
                  return label;
                },
              },
            },
          },
          scales: {
            y: {
              beginAtZero: type === "ì„±ì¥ë¥ " ? true : false,
              ticks: {
                callback: function (value) {
                  if (type === "ì„±ì¥ë¥ ") {
                    return value + "%";
                  }
                  return value.toLocaleString();
                },
                font: {
                  size: 12,
                },
              },
              grid: {
                color: "rgba(0, 0, 0, 0.05)",
              },
            },
            x: {
              ticks: {
                font: {
                  size: 12,
                  weight: "bold",
                },
              },
              grid: {
                display: false,
              },
            },
          },
        };
      }
    </script>
  </body>
</html>
